# Script to download and later combine microdata
```{r}
library(readr)
library(dplyr)
library(data.table)
library(CTIS)
# Skript to Download microdata
setwd("data/microdata")
date_vec <- seq(as.Date("2020-04-23"), as.Date("2022-06-25"), by = "day") # Second date is end date
username <- readline(prompt = "Enter username for CTIS login: ")
password <- readline(prompt = "Enter password for CTIS login: ")
for (date_index in seq_len(length(date_vec))) {
  CTIS::CTIS_microdata(username = username, password = password, date = as.character(date_vec[date_index]), type = "full")
}

# Combine microdata
colum_name_vec = c("survey_region", "survey_version", "weight", "Finished", "RecordedDate", "module",
                      "intro1", "intro2", "A1", "A2_2_1", "A2_2_2", "D1", "D2", "D4", "D5",
                      "E3", "V11", "E4", "E8", "E2", "E5", "E7a", "D7a", "D10")
colum_name_vec_shorted = c("survey_region", "survey_version", "weight", "Finished", "RecordedDate",
                      "intro1", "intro2", "A1", "A2_2_1", "A2_2_2", "D1", "D2", "D4",
                      "E3", "E4", "E2", "E5")
# Create list of files
csv_files <- list.files(pattern = "\\.csv$")

CTIS_microdata_shorted <- data.frame()
for (file in csv_files) {
  CTIS_microdata_shorted <- bind_rows(CTIS_microdata_shorted, 
            readr::read_csv(file = file, 
                            col_names = TRUE, 
                            col_select = colum_name_vec_shorted))
}
setwd("..")
write_csv(x = CTIS_microdata_shorted, file = "protected_data/CTIS_microdata_shorted.csv")


setwd("./microdata")
csv_files <- list.files(pattern = "\\.csv$")
CTIS_microdata <- data.frame()
for (file in csv_files) {
  print(file)
  CTIS_microdata <- bind_rows(CTIS_microdata,
            readr::read_csv(file = file,
                            col_names = TRUE,
                            col_select = any_of(colum_name_vec),
                            col_types = cols(survey_version = "c")))
}
setwd("..")
write_csv(x = CTIS_microdata, file = "protected_data/CTIS_microdata_complete.csv")

# Data Cleaning -----------------------------------------------------------

# Loading the microdata
CTIS_microdata <- readr::read_csv(file = "protected_data/CTIS_microdata_complete.csv", col_names = TRUE,
                                  col_types = c(.default = "f", weight = "d", RecordedDate = "T"))

# Validation if unique days equal number of csv files
length(unique(as.Date(CTIS_microdata_complete$RecordedDate))) == length(csv_files)

# Show levels for all factor variables
sapply(CTIS_microdata[,-c(3,5)], levels)

# Remove all observations with absurd E5 (number of people slept at the same place) values
CTIS_microdata_clean <- 
  CTIS_microdata[-(which(!(CTIS_microdata[["E5"]] %in% c(1:75, "NA", -99, -77)))), ]

# Remove all observations with unfitting D10 (main activity of the business) values
CTIS_microdata_clean <- 
  CTIS_microdata_clean[-(which(!(CTIS_microdata_clean[["D10"]] %in% c(1:15, "NA", -99, -77)))), ]

# Remove all observations with unfitting E7a (Number of rooms for sleeping) values
CTIS_microdata_clean <- 
  CTIS_microdata_clean[-(which(!(CTIS_microdata_clean[["E7a"]] %in% c(1:50, "NA", -99, -77)))), ]

# Drop Levels
CTIS_microdata_clean <- droplevels(CTIS_microdata_clean)

# Show levels for all factor variables on cleaned up data
sapply(CTIS_microdata_clean[,-c(3,5)], levels)

# Save clean microdata
write_csv(x = CTIS_microdata_clean, file = "protected_data/CTIS_microdata_clean.csv")
```

