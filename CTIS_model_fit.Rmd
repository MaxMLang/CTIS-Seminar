---
title: "CTIS_Model"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(include = FALSE)
library(tidyverse)
library(party)
library(rpart)
library(caret)
library(rpart.plot)
library(mboost)
library(MLmetrics)
library(corrplot)
library(olsrr)
library(glmnet)
library(desctable)
library(pander)
library(effects)
library(arsenal)
library(mboost)
library(MASS)
```

```{r include=FALSE}
CTIS_micro <- readRDS("~/CTIS-Seminar/data/protected_data/CTIS_microdata_cleanV3.RDS")

CTIS_macro <- readRDS("~/CTIS-Seminar/data/data_CTIS_policy.RDS")
```

```{r}
head(CTIS_macro)
str(CTIS_macro)
```
# Check correlation before regression
```{r}
# Get numeric data
nums <- unlist(lapply(CTIS_macro, is.numeric), use.names = FALSE)


res <- cor(CTIS_macro[ , nums], use = "complete.obs")
round(res, 2)

corrplot(res, method="color")
```


# Global Mean
```{r}
CTIS_macro %>% 
  group_by(data.survey_date) %>% 
  summarise(global_mean = mean(anxious_7d)) %>% 
  ggplot(aes(x = data.survey_date, y = global_mean))+
  geom_line()
```

# Continent Mean
```{r}
CTIS_macro %>% 
  group_by(data.survey_date, continent) %>% 
  summarise(continent_mean = mean(anxious_7d)) %>% 
  ggplot(aes(x = data.survey_date, y = continent_mean))+
  geom_line()+
  facet_wrap(vars(continent))
```

# Global Model Fit

```{r}
global_aggregate <- CTIS_macro %>% 
group_by(data.survey_date) %>%
summarise(across(everything(), ~ mean(.x, na.rm = TRUE))) %>% 
  select(data.survey_date, anxious_7d, finance, food_security, worried_become_ill,
         retail_and_recreation, grocery_and_pharmacy, residential, transit_stations, parks,
         workplaces) # Select only columns that have a mean



model <- lm(anxious_7d ~ ., data = global_aggregate)
best_sub <- ols_step_best_subset(model)
plot(best_sub)
```

```{r}
best_sub # Model 6 looks nice
```
```{r}
best_sub_model <- lm(formula = anxious_7d ~ data.survey_date + finance+ retail_and_recreation + grocery_and_pharmacy + residential + transit_stations, 
                     data = global_aggregate)

summary(best_sub_model)
```

# Plot with simple model 
```{r}
predicted_df <- data.frame(anxious_pred = predict(best_sub_model, global_aggregate), data.survey_date = global_aggregate$data.survey_date)


global_aggregate %>% 
  ggplot(aes(x = data.survey_date, y = anxious_7d))+
  geom_line()+
  geom_line(color='red',data = predicted_df, aes(x = data.survey_date, y = anxious_pred))
```

# Global Model Fit

```{r}
global_aggregate <- CTIS_macro %>% 
group_by(data.survey_date) %>%
summarise(across(everything(), ~ mean(.x, na.rm = TRUE))) %>% 
  select(data.survey_date, anxious_7d, finance, food_security, worried_become_ill,
         retail_and_recreation, grocery_and_pharmacy, residential, transit_stations, parks,
         workplaces) # Select only columns that have a mean



model <- lm(anxious_7d ~ ., data = global_aggregate)
best_sub <- ols_step_best_subset(model)
plot(best_sub)
```

```{r}
best_sub # Model 6 looks nice
```
```{r}
best_sub_model <- lm(formula = anxious_7d ~ data.survey_date + finance+ retail_and_recreation + grocery_and_pharmacy + residential + transit_stations, 
                     data = global_aggregate)

summary(best_sub_model)
```

# Plot with simple model 
```{r}
predicted_df <- data.frame(anxious_pred = predict(best_sub_model, global_aggregate), data.survey_date = global_aggregate$data.survey_date)


global_aggregate %>% 
  ggplot(aes(x = data.survey_date, y = anxious_7d))+
  geom_line()+
  geom_line(color='red',data = predicted_df, aes(x = data.survey_date, y = anxious_pred))
```
# Modelldiagnose
```{r}
# Histogram to check the distribution of errors
layout(matrix(1:9, ncol = 3))
hist(best_sub_model$residuals, color = "grey")
```
```{r}
# Checkign important plots
plot(best_sub_model)
```

# Continent Model Fit

```{r}
continent_aggregate <- CTIS_macro %>% 
group_by(data.survey_date, continent) %>%
  mutate(numeric_stay_home = as.numeric(stay_home_requirements)) %>% 
  summarise(across(everything(), ~ mean(.x, na.rm = TRUE))) %>%
  select(data.survey_date, anxious_7d, finance, food_security, worried_become_ill,
         retail_and_recreation, grocery_and_pharmacy, residential, transit_stations, parks,
         workplaces, continent, numeric_stay_home) %>% 
  mutate(numeric_stay_home = round(numeric_stay_home, 1))# Select only columns that have a mean



model <- lm(anxious_7d ~ ., data = global_aggregate)
best_sub <- ols_step_best_subset(model)
plot(best_sub)
```

```{r}
best_sub # Model 6 looks nice
```
```{r}
best_sub_model <- lm(formula = anxious_7d ~ data.survey_date + finance+ retail_and_recreation + grocery_and_pharmacy + residential + transit_stations, 
                     data = global_aggregate)

summary(best_sub_model)
```

# Plot with simple model 
```{r}
predicted_df <- data.frame(anxious_pred = predict(best_sub_model, global_aggregate), data.survey_date = global_aggregate$data.survey_date)


global_aggregate %>% 
  ggplot(aes(x = data.survey_date, y = anxious_7d))+
  geom_line()+
  geom_line(color='red',data = predicted_df, aes(x = data.survey_date, y = anxious_pred))
```

# Global Model Fit

```{r}
global_aggregate <- CTIS_macro %>% 
group_by(data.survey_date) %>%
summarise(across(everything(), ~ mean(.x, na.rm = TRUE))) %>% 
  select(data.survey_date, anxious_7d, finance, food_security, worried_become_ill,
         retail_and_recreation, grocery_and_pharmacy, residential, transit_stations, parks,
         workplaces) # Select only columns that have a mean



model <- lm(anxious_7d ~ ., data = global_aggregate)
best_sub <- ols_step_best_subset(model)
plot(best_sub)
```

```{r}
best_sub # Model 6 looks nice
```
```{r}
best_sub_model <- lm(formula = anxious_7d ~ data.survey_date + finance+ retail_and_recreation + grocery_and_pharmacy + residential + transit_stations, 
                     data = global_aggregate)

summary(best_sub_model)
```

# Plot with simple model 
```{r}
predicted_df <- data.frame(anxious_pred = predict(best_sub_model, global_aggregate), data.survey_date = global_aggregate$data.survey_date)


global_aggregate %>% 
  ggplot(aes(x = data.survey_date, y = anxious_7d))+
  geom_line()+
  geom_line(color='red',data = predicted_df, aes(x = data.survey_date, y = anxious_pred))
```
# Modelldiagnose
```{r}
# Histogram to check the distribution of errors
layout(matrix(1:9, ncol = 3))
hist(best_sub_model$residuals, color = "grey")
```
```{r}
# Checkign important plots
plot(best_sub_model)
```

# Continent Model


```{r}
continent_aggregate <- CTIS_macro %>% 
group_by(data.survey_date, continent) %>%
summarise(across(everything(), ~ mean(.x, na.rm = TRUE))) %>% 
  select(data.survey_date, anxious_7d, finance, food_security, worried_become_ill,
         retail_and_recreation, grocery_and_pharmacy, residential, transit_stations, parks,
         workplaces, continent) # Select only columns that have a mean
```
# Europe
```{r}
europe_aggregate <- continent_aggregate %>% 
  filter(continent %in% "Europe") %>% 
  select(- continent)

model <- lm(anxious_7d ~ ., data = europe_aggregate)

best_sub_continent <- ols_step_best_subset(model)
 plot(best_sub_continent)
```

```{r}
best_sub_continent  # Model 8 looks nice
```
```{r}
best_sub_model_continent <- lm(formula = anxious_7d ~ data.survey_date + finance + grocery_and_pharmacy + residential + transit_stations + parks + workplaces , data = continent_aggregate)

summary(best_sub_model_continent)
```

# Plot with simple model 
```{r}
predicted_df <- data.frame(anxious_pred = predict(best_sub_model_continent, europe_aggregate), data.survey_date = europe_aggregate$data.survey_date)


europe_aggregate %>% 
  ggplot(aes(x = data.survey_date, y = anxious_7d))+
  geom_line()+
  geom_line(color='red',data = predicted_df, aes(x = data.survey_date, y = anxious_pred))
```
# Modelldiagnose
```{r}
# Histogram to check the distribution of errors
layout(matrix(1:9, ncol = 3))
hist(best_sub_model_continent$residuals, color = "grey")
```
```{r}
# Checkign important plots
plot(best_sub_model_continent)
```


# Logistic regression
```{r}
set.seed(1234)
CTIS_micro$worried <- ifelse(CTIS_micro$D1 %in% levels(CTIS_micro$D1)[4:5], TRUE, FALSE )
ind <- sample(2, nrow(CTIS_micro), replace = T, prob = c(0.5, 0.5))
train <- CTIS_micro[ind == 1,]
test <- CTIS_micro[ind == 2,]
model_1 <- glm(worried ~ E3 + E4 + E2 + V11 + E8 ,family=binomial(link='logit'), data=train)
model_2 <- glm(worried ~ E3 + E4 + E2 + V11 ,family=binomial(link='logit'), data=train)
model_3 <- glm(D1 ~ E4 + E8 + E3 + D7a ,family=binomial(link='logit'), data=train)
```

```{r}
test <- na.omit(test)

fitted.results_model1 <- predict(model_1, newdata= test[c("E3", "E4", "E2", "V11", "E8", "worried", "D7a")], type='response')
fitted.results_model2 <- predict(model_2, newdata= test[c("E3", "E4", "E2", "V11", "E8", "worried", "D7a")], type='response')
fitted.results_model3 <- predict(model_3, newdata= test[c("E3", "E4", "E2", "V11", "E8", "worried", "D7a")], type='response')

```
# Model 1 diagnostics
```{r}
fitted.results_model1 <- ifelse(fitted.results_model1 > 0.5,1,0)
misClasificError <- mean(as.logical(fitted.results_model1) != test$worried)
print(paste('Accuracy',1-misClasificError))
F1_Score(test$worried, as.logical(fitted.results_model1))
```
# Model 2 diagnostics
```{r}
fitted.results_model2 <- ifelse(fitted.results_model2 > 0.5,1,0)
misClasificError <- mean(as.logical(fitted.results_model2) != test$worried)
print(paste('Accuracy',1-misClasificError))
F1_Score(test$worried, as.logical(fitted.results_model2))
```
# Model 3 diagnostics
```{r}
fitted.results_model3 <- ifelse(fitted.results_model3 > 0.5,1,0)
misClasificError <- mean(as.logical(fitted.results_model3) != test$worried)
print(paste('Accuracy',1-misClasificError))
F1_Score(test$worried, as.logical(fitted.results_model3))
```


# mboost approach
```{r}
CTIS_micro$worried <- as.factor(CTIS_micro$worried)
glm <- glmboost(worried ~ E3 + E4 + E2 + V11 + E8 , family = Binomial(link='logit'), 
                data = CTIS_micro, control= boost_control(trace=TRUE))

```

# Component-Wise Boosting
```{r}
boost_micro <- glmboost(D1 ~ RecordedDate + D2 + D4 + E3 + E4 + E2 + E5 + 
                          D5 + D10 + V11 + E8 + E7a + D7a + worried, 
                      data = CTIS_micro,
                      control = boost_control(nu = 0.1, mstop = 200))
summary(boost_micro)


boost_micro <- glmboost(D1 ~ + E4 + E8 + E3 + D7a, 
                      data = CTIS_micro,
                      control = boost_control(nu = 0.1, mstop = 200))
summary(boost_micro)

```

# Ordinal logistic regression
```{r}
# Doesn't run
ord_log_reg_model <- polr(D1 ~ E4 + E8 + E3 + D7a, data = CTIS_micro, Hess = TRUE)
summary(boost_micro)
```

