---
title: "CTIS Mental Health"
author: "Christian Hobelsberger, Max Lang, Elisa Shima"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
devtools::install_github("CaroHaensch/CTIS")
library(CTIS)
library(tidyverse)
library(reshape2)
library(corrplot)
library(ozmaps)
library(RColorBrewer)
library(countrycode)
library(gganimate)
library(gifski)
library(rgdal)
library(tmap)
library(maps)
library(sf)
library(tigris)
library(rworldmap)
```


## Data Import & Wrangling

We are using the R Package CTIS to get access to the API Interface, more information on <https://github.com/CaroHaensch/CTIS>.

```{r Data Import & Wrangling}
indicator_list = list("anxious_7d", "depressed_7d", "worried_become_ill", "finance", "food_security")

data <- lapply(X = indicator_list, 
               FUN = function(x){
                 CTIS_open_data_country(indicator = x, type = "daily", country = "all", daterange = "")
                 })
data <- as.data.frame(do.call(rbind, data))
data_trimmed <- data[,c(1:5, 7)]
data_aggregated <- dcast(data = data_trimmed, 
                         formula = data.country+data.iso_code+data.gid_0+data.survey_date~data.indicator, 
                         value.var = "data.pct")

data_aggregated$data.country <- as.factor(data_aggregated$data.country)
data_aggregated$data.iso_code <- as.factor(data_aggregated$data.iso_code)
data_aggregated$data.gid_0 <- as.factor(data_aggregated$data.gid_0)

data_aggregated$data.survey_date <- as.Date(x = data_aggregated$data.survey_date, "%Y%m%d")



write.csv(data_aggregated,"data/data_aggregated.csv", row.names = FALSE)
data_CTIS = read.csv(file = "data/data_aggregated.csv")
data_CTIS$data.country <- as.factor(data_CTIS$data.country)
data_CTIS$data.iso_code <- as.factor(data_CTIS$data.iso_code)
data_CTIS$data.gid_0 <- as.factor(data_CTIS$data.gid_0)

data_CTIS$data.survey_date <- as.Date(x = data_CTIS$data.survey_date)

```

# Read our world in data (<https://ourworldindata.org/policy-responses-covid>)

```{r Policy Data Import}
policy_income_support <- read.csv("data/ourworldindata-policy-responses/income-support-covid.csv")
policy_stay_at_home <- read.csv("data/ourworldindata-policy-responses/stay-at-home-covid.csv")
policy_changes_visitors <- read.csv("data/ourworldindata-policy-responses/changes-visitors-covid.csv")
policy_school_closures <- read.csv("data/ourworldindata-policy-responses/school-closures-covid.csv")

names(policy_income_support)[1:3] <- c("data.country", "data.iso_code", "data.date")
names(policy_stay_at_home)[1:3] <- c("data.country", "data.iso_code", "data.date")
names(policy_changes_visitors)[1:3] <-  c("data.country", "data.iso_code", "data.date")
names(policy_school_closures)[1:3] <- c("data.country", "data.iso_code", "data.date")

policy_data <- policy_stay_at_home %>% 
  left_join(policy_income_support, by = c("data.country", "data.iso_code", "data.date")) %>% 
  left_join(policy_changes_visitors, by = c("data.country", "data.iso_code", "data.date")) %>% 
  left_join(policy_school_closures, by = c("data.country", "data.iso_code", "data.date"))

policy_data$data.date <- as.Date(policy_data$data.date)
# Scale from 0 to 3 restrictions
policy_data$stay_home_requirements <- factor(policy_data$stay_home_requirements, ordered = TRUE) 
policy_data$income_support <- factor(policy_data$income_support, ordered = TRUE)
policy_data$school_closures<- factor(policy_data$school_closures, ordered = TRUE)
```

# Large Data with policy

```{r}
data_CTIS_policy <- data_CTIS %>% 
  left_join(policy_data, by = c("data.country", "data.iso_code", "data.survey_date" = "data.date"))
# Adding continent
data_CTIS_policy$continent <- countrycode(data_CTIS_policy$data.country, origin = "country.name", destination = "continent")
```


# Create mapping data
```{r}
data("World")
world <- World[c("iso_a3", "sovereignt", "geometry")]
colnames(world) <- c("data.iso_code", "data.country", "geometry")

# WGS 84 standard
data_CTIS_map <- world %>%
  full_join(data_CTIS_policy, by = c("data.iso_code", "data.country"))

#data_CTIS_map <- data_CTIS_map[!st_is_empty(data_CTIS_map),,drop=FALSE]

data_CTIS_map <-  data_CTIS_map %>% 
filter( is.na(st_dimension(.)) == FALSE )

# Match Countrycode again because now new countries that were not in the survey but now joined
data_CTIS_map$continent <- countrycode(data_CTIS_map$data.country, origin = "country.name", destination = "continent")
```

## Chris

### First look at data

Brief first look at the CTIS data.

```{r Chris: Data glimpse}
# Read data
data_CTIS = read.csv(file = "data/data_aggregated.csv")
data_CTIS$data.country <- as.factor(data_CTIS$data.country)
data_CTIS$data.iso_code <- as.factor(data_CTIS$data.iso_code)
data_CTIS$data.gid_0 <- as.factor(data_CTIS$data.gid_0)

data_CTIS$data.survey_date <- as.Date(x = data_CTIS$data.survey_date)

# Number of NAs for each row
colSums(is.na(data_CTIS))

# Number of countries with equal or more than 600 observations
sum(table(data_CTIS$data.country) >= 600)

# Names of the countries with equal or more than 600 observations
names_sufficient_data = names(which(table(data_CTIS$data.country) >= 600))
names_sufficient_data

# Get the 10 countries with the highest amount of observations
names(sort(table(data_CTIS$data.country), decreasing = TRUE)[1:10])

head(data_CTIS)

summary(data_CTIS)

# Get mean anxious_7d for each country
data_CTIS %>% group_by(data.country) %>% summarise(mean(anxious_7d, na.rm = TRUE))

# Arrange by mean_anxious_7d of each country
mean_anxious_7d_arranged <- data_CTIS %>% 
  filter(data.country %in% names_sufficient_data) %>%
  group_by(data.country) %>% 
  summarise(mean_anxious_7d = mean(anxious_7d, na.rm = TRUE)) %>% 
  arrange(mean_anxious_7d)
mean_anxious_7d_arranged

# Arrange by median_anxious_7d of each country
median_anxious_7d_arranged <- data_CTIS %>% 
  filter(data.country %in% names_sufficient_data) %>%
  group_by(data.country) %>% 
  summarise(median_anxious_7d = median(anxious_7d, na.rm = TRUE)) %>% 
  arrange(median_anxious_7d)

# Calculating pearson correlation between anxious_7d and depressed_7d: 0.8064084
drop_na(data_CTIS[, 5:6]) |> cor()

# Plot: Denisity of mean_anxious_7d
ggplot(data = mean_anxious_7d_arranged, mapping = aes(y = mean_anxious_7d)) + geom_density() + 
  coord_flip() +
  labs(title = "Denisity of mean_anxious_7d")
ggsave("graphics/density_mean_anxious_7d.png", width = 12, height = 9)

# First set of plot
country_subset1 <- c("Germany", "Mexico", "South Africa")
data_CTIS_country_subset1 = data_CTIS %>%
  filter(data.country %in% country_subset1)

ggplot(data = data_CTIS_country_subset1, 
       mapping = aes(x = data.survey_date, y = anxious_7d, color = data.country)) +
  geom_line() +
  labs(title = "anxious_7d vs. date (1)")
ggsave("graphics/anxious_7d_set1.png", width = 12, height = 9)

ggplot(data = data_CTIS_country_subset1, 
       mapping = aes(x = data.survey_date, y = depressed_7d, color = data.country)) +
  geom_line() +
  labs(title = "depressed_7d vs. date (1)")
ggsave("graphics/depressed_7d_set1.png", width = 12, height = 9)

# Second set of plot
country_subset2 = c("Denmark", "India", "Turkey")
data_CTIS_country_subset2 = data_CTIS %>%
  filter(data.country %in% country_subset2)

ggplot(data = data_CTIS_country_subset2, 
       mapping = aes(x = data.survey_date, y = anxious_7d, color = data.country)) +
  geom_line() +
  labs(title = "anxious_7d vs. date (2)")
ggsave("graphics/anxious_7d_set2.png", width = 12, height = 9)

ggplot(data = data_CTIS_country_subset2, 
       mapping = aes(x = data.survey_date, y = depressed_7d, color = data.country)) +
  geom_line() +
  labs(title = "depressed_7d vs. date (2)")
ggsave("graphics/depressed_7d_set2.png", width = 12, height = 9)

# Third set of plot
country_subset3 = c("Norway", "Hungary", "Egypt")
data_CTIS_country_subset3 = data_CTIS %>%
  filter(data.country %in% country_subset3)

ggplot(data = data_CTIS_country_subset3, 
       mapping = aes(x = data.survey_date, y = anxious_7d, color = data.country)) +
  geom_line() +
  labs(title = "anxious_7d vs. date (3)")
ggsave("graphics/anxious_7d_set3.png", width = 12, height = 9)

ggplot(data = data_CTIS_country_subset3, 
       mapping = aes(x = data.survey_date, y = depressed_7d, color = data.country)) +
  geom_line() +
  labs(title = "depressed_7d vs. date (3)")
ggsave("graphics/depressed_7d_set3.png", width = 12, height = 9)

# Boxplots: Total subset
total_subset <- c(country_subset1, country_subset2, country_subset3)
data_CTIS_total_subset = data_CTIS %>%
  filter(data.country %in% total_subset)

ggplot(data = data_CTIS_total_subset, 
       mapping = aes(y = anxious_7d, color = data.country)) +
  geom_boxplot() +
  labs(title = "anxious_7d Boxplot")
ggsave("graphics/anxious_7d_boxplot.png", width = 12, height = 9)

ggplot(data = data_CTIS_total_subset, 
       mapping = aes(y = depressed_7d, color = data.country)) +
  geom_boxplot() +
  labs(title = "depressed_7d Boxplot")
ggsave("graphics/depressed_7d_boxplot.png", width = 12, height = 9)

```

### Chris: Advanced microdata analysis

```{r Chris: microdata analysis}
# Loading the microdata
CTIS_microdata <- readr::read_csv(file = "data/protected_data/CTIS_microdata_clean.csv", col_names = TRUE,
                                  col_types = c(.default = "f", weight = "d", RecordedDate = "T"))

# Number of distinct dates
length(unique(as.Date(CTIS_microdata$RecordedDate)))

# Get an brief overview over the data
summary(CTIS_microdata[["E4"]])

```


# Max

## Data preparation

```{r Max: Data preparation}
country_subset_large <- c("Germany", "Mexico", "South Africa", "Norway", "Hungary",
                          "Egypt", "Denmark", "India", "Turkey")
data_CTIS_country_subset_large = data_CTIS %>%
  filter(data.country %in% country_subset_large)


data_policy_subset_large = policy_data %>% 
  filter(data.country %in% country_subset_large)

data_CTIS_policy_large <- data_CTIS_country_subset_large %>% 
  left_join(data_policy_subset_large, by = c("data.country",
                                             "data.iso_code",
                                              "data.survey_date" = "data.date"))
```

-   Only turkey and india have level 3 stay home requirements

```{r Check for hard restricting countries}
hard_countries <- unique(data_CTIS_policy_large %>% 
  filter(stay_home_requirements %in% 2:3 & school_closures %in% 2:3) %>% select(data.country))[["data.country"]]
data_CTIS_policy_large %>% 
  filter(stay_home_requirements %in% 3) %>% select(data.country) %>%  unique()
```

## Anxiety

```{r Anxiety over time for country selection}
anx_hard_countries <- data_CTIS_policy_large %>% filter(data.country %in% hard_countries) %>% select(anxious_7d)

data_CTIS_policy_large %>% 
  filter(stay_home_requirements %in% 2:3 & school_closures %in% 2:3) %>% ggplot(aes(x= data.survey_date, y = anxious_7d, color = data.country)) + 
  geom_line() + 
  geom_hline(yintercept = mean(anx_hard_countries$anxious_7d, na.rm = T)) + 
  geom_hline(yintercept = mean(data_CTIS_policy_large$anxious_7d), color = "blue")+
  scale_color_viridis_d(option = "A")
```

```{r school closure in 3}
hard_countries <- unique(data_CTIS_policy_large %>% 
  filter(school_closures %in% 3) %>% select(data.country))[["data.country"]]

anx_hard_countries <- data_CTIS_policy_large %>% filter(data.country %in% hard_countries) %>% select(anxious_7d)

data_CTIS_policy_large %>% 
  filter(school_closures %in% 3) %>% ggplot(aes(x= data.survey_date, y = anxious_7d, color = data.country)) + 
  geom_line() + 
  geom_hline(yintercept = mean(anx_hard_countries$anxious_7d, na.rm = T)) + 
  geom_hline(yintercept = mean(data_CTIS_policy_large$anxious_7d), color = "blue")+
  scale_color_viridis_d(option = "A")
```

## Depression

```{r Depression over time by country}
hard_countries <- unique(data_CTIS_policy_large %>% 
  filter(stay_home_requirements %in% 2:3 & school_closures %in% 2:3) %>% select(data.country))[["data.country"]]

anx_hard_countries <- data_CTIS_policy_large %>% filter(data.country %in% hard_countries) %>% select(depressed_7d)

data_CTIS_policy_large %>% 
  filter(stay_home_requirements %in% 2:3 & school_closures %in% 2:3) %>% ggplot(aes(x= data.survey_date, y = depressed_7d, color = data.country)) + 
  geom_line() + 
  geom_hline(yintercept = mean(anx_hard_countries$depressed_7d, na.rm = T)) + 
  geom_hline(yintercept = mean(data_CTIS_policy_large$depressed_7d), color = "blue")+
  scale_color_viridis_d(option = "A")
```

## Correlation Matrix

```{r corrplot for subset}
numeric_data <- data_CTIS_policy_large %>% select(anxious_7d, depressed_7d, finance, food_security, worried_become_ill, parks, workplaces, residential, transit_stations)
cormat <- cor(numeric_data, use = "complete.obs")

corrplot(cormat, method = "color")
```

# Scatterplot stay home park movement and anxiety

```{r}
data_CTIS_policy_large %>% 
  #filter(data.survey_date %in% as.Date("2021-03-01")) %>% 
  ggplot(aes(x = parks, y = anxious_7d, color = stay_home_requirements))+
  facet_wrap(facets = vars(data.country))+
  geom_point(alpha = 0.2)
  
```

# Boxplots Stay Home requirements / school closure influence on mental health

```{r}
data_CTIS_policy_large %>% 
  ggplot(aes(x = stay_home_requirements, y = anxious_7d))+
  facet_wrap(vars(data.country))+
  geom_boxplot()
```

```{r}
data_CTIS_policy_large %>% 
  ggplot(aes(x = school_closures, y = anxious_7d))+
  facet_wrap(vars(data.country))+
  geom_boxplot()+
  geom_hline(yintercept = mean(data_CTIS$anxious_7d, na.rm = TRUE))
```

```{r}
data_CTIS_policy_large %>% 
  ggplot(aes(x = stay_home_requirements, y = finance))+
  facet_wrap(vars(data.country))+
  geom_boxplot()+
  geom_hline(yintercept = mean(data_CTIS$finance, na.rm = TRUE))
```

```{r}
data_CTIS_policy_large %>% 
  ggplot(aes(x = stay_home_requirements, y = finance))+
  facet_wrap(vars(data.country))+
  geom_boxplot()+
  geom_hline(yintercept = mean(data_CTIS$finance, na.rm = TRUE))
```



# Using complete data set

```{r}
numeric_data <- data_CTIS_policy %>% select(anxious_7d, depressed_7d, finance, food_security, worried_become_ill, parks, workplaces, residential, transit_stations)
cormat <- cor(numeric_data, use = "complete.obs")

corrplot(cormat, method = "color")
```

# Continent grouped

```{r Anxiety continent level}
data_CTIS_policy %>% 
  group_by(continent, data.survey_date) %>% 
  summarise(continent_mean_anxious7d = mean(anxious_7d, na.rm = TRUE)) %>% 
  ggplot(aes(x = data.survey_date, y = continent_mean_anxious7d, color = continent))+
    geom_line()+
  scale_color_viridis_d()
```

```{r Anxiety continent level}
data_CTIS_policy %>% 
  group_by(continent, data.survey_date) %>% 
  summarise(continent_mean_anxious7d = mean(anxious_7d, na.rm = TRUE)) %>% 
  ggplot(aes(x = data.survey_date, y = continent_mean_anxious7d))+
  facet_wrap(vars(continent))+
    geom_line()
```

# Just for Europe

-   Peak in Europe in on February 27 is probably bc of Ukraine war

```{r Anxiety continent level}
data_CTIS_policy %>% 
  group_by(continent, data.survey_date) %>% 
  filter(continent %in% "Europe") %>% 
  summarise(continent_mean_anxious7d = mean(anxious_7d, na.rm = TRUE)) %>% 
  ggplot(aes(x = data.survey_date, y = continent_mean_anxious7d))+
  facet_wrap(vars(continent))+
    geom_line()
```

```{r}
data_CTIS_policy %>% filter(continent %in% "Europe") %>% filter(data.survey_date %in% as.Date("2022-02-27")) %>% select(anxious_7d, data.country) %>% arrange(desc(anxious_7d))
```

```{r Anxiety continent level}
data_CTIS_policy %>% 
  group_by(continent, data.survey_date) %>% 
  summarise(continent_mean_depressd7d = mean(depressed_7d, na.rm = TRUE)) %>% 
  ggplot(aes(x = data.survey_date, y = continent_mean_depressd7d))+
  facet_wrap(vars(continent))+
    geom_line()
```



```{r}
# data: A dataframe containing the CTIS Survey data
# date: A string setting the date of the data (Format: 2022-03-22)
# variable: A string containing the variable name

plot_survey_world <- function(data, date, variable) {
  map_data <- data %>% filter(data.survey_date %in% as.Date(date))
  map_data <- joinCountryData2Map(map_data, nameJoinColumn = "data.iso_code")
  mapCountryData(map_data, nameColumnToPlot = variable, 
                 colourPalette = brewer.pal(7,"OrRd"), mapTitle = paste(variable, date))
}
head(data_CTIS_policy)
plot_survey_world(data_CTIS_policy, "2020-04-28", "anxious_7d")
plot_survey_world(data_CTIS_policy, "2021-01-28", "anxious_7d")
plot_survey_world(data_CTIS_policy, "2021-04-28", "anxious_7d")

```

# Creating map for shiny app
## Raw function for plotting for debugging
```{r}
# Continent: "Asia" "Africa" "Europe" "Americas" "Oceania" | valid inputs
area <- "Europe"
# Variable: "anxious_7d" "finance" "depressed_7d" 
variable <- "anxious_7d"
# survey_date
survey_date <- "2021-01-28"
# Mode: "plot" "view
mode <- "plot"


mapdata <- data_CTIS_map %>% 
  select(continent, variable, geometry, data.country, data.iso_code, data.survey_date) %>% 
  filter(data.survey_date %in% as.Date(survey_date))

# If we filter for specific data we lose geometries for countries with no obs at that data therefore we need to add the geo data + NA for survey data
missing_countries <- setdiff(world$data.country, mapdata$data.country)
missing_data <- world %>% filter(data.country %in% missing_countries)
missing_columns <- setdiff(colnames(mapdata), colnames(missing_data))
for (column in 1:length(missing_columns)) {
  missing_data[missing_columns[column]] <- NA
}

mapdata <- rbind(mapdata, missing_data)

tmap_mode("plot")
tm_shape(mapdata)+
  tm_fill("anxious_7d")+
  tm_borders()
```

# plot_data_map
```{r}
plot_global_map <- function(data, variable, survey_date, mode = "plot", ...){
  mapdata <- data %>% 
  select(continent, variable, geometry, data.country, data.iso_code, data.survey_date, school_closures, stay_home_requirements) %>% 
  filter(data.survey_date %in% as.Date(survey_date))
# If we filter for specific data we lose geometries for countries with no obs at that data therefore   we need to add the geo data + NA for survey data
  missing_countries <- setdiff(world$data.country, mapdata$data.country)
  missing_data <- world %>% filter(data.country %in% missing_countries)
  missing_columns <- setdiff(colnames(mapdata), colnames(missing_data))
  for (column in 1:length(missing_columns)) {
    missing_data[missing_columns[column]] <- NA
  }
  mapdata <- rbind(mapdata, missing_data)
  tmap_mode(mode)
  tm_shape(mapdata)+
    tm_fill(variable, ...)+
    tm_borders()
}
```


```{r}
plot_continent_map <- function(data, variable, area, survey_date, mode = "plot", ...){
  mapdata <- data %>% 
  select(continent, variable, geometry, data.country, data.iso_code, data.survey_date, school_closures, stay_home_requirements) %>% 
  filter(data.survey_date %in% as.Date(survey_date)) %>% 
  filter(continent %in% area)

  tmap_mode(mode)
  tm_shape(mapdata)+
    tm_borders()+
    tm_polygons(variable, ...)
}
```

```{r}
plot_global_map(data_CTIS_map, variable = "anxious_7d",survey_date = "2021-01-28", mode = "view", id = "data.country", popup.vars = c("Anxiety last 7 days:" = "anxious_7d", "Stay home req. level" = "stay_home_requirements:", "School closure level" = "school_closures"))

plot_continent_map(data_CTIS_map, variable = "anxious_7d", area = "Europe", survey_date = "2021-01-28", mode = "view", id = "data.country", popup.vars = c("Anxiety last 7 days:" = "anxious_7d", "Stay home req. level" = "stay_home_requirements:", "School closure level" = "school_closures"))
```
